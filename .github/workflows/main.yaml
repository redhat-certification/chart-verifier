name: Create container image on main

# This workflow builds a container image for each commit on the main branch.
# The image is tagged with the (short) commit ID, "main" and "0.1.0" (i.e. the
# development release), and pushed to Quay.

on:
    push:
        branches:
            - main
env:
    DEV_RELEASE: 0.1.0
    CONTAINER_REGISTRY: quay.io/redhat-certification
jobs:
    image:
      name: Build and push container images
      runs-on: ubuntu-latest
      permissions:
        contents: read
      steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          persist-credentials: false

      - name: Get commit ID
        id: get_commit_id
        run: |
          # Make the short commit ID available to the following steps.
          COMMIT_ID=$(git rev-parse --short HEAD)
          echo "commit_id=$COMMIT_ID" | tee -a $GITHUB_OUTPUT

      - name: Build container images
        id: build_container_images
        env:
          COMMIT_ID: ${{ steps.get_commit_id.outputs.commit_id }}
        run: |
            podman version
            # Build podman images locally
            make build-image "IMAGE_TAG=${COMMIT_ID}" QUAY_EXPIRE_AFTER=1w
            make build-image IMAGE_TAG=main
            podman tag "${CONTAINER_REGISTRY}/chart-verifier:main" "${CONTAINER_REGISTRY}/chart-verifier:${DEV_RELEASE}"

      - name: Push to quay.io
        id: push_to_quay
        uses: redhat-actions/push-to-registry@5ed88d269cf581ea9ef6dd6806d01562096bee9c # v2.8
        with:
          image: chart-verifier
          tags: |
            ${{ steps.get_commit_id.outputs.commit_id }}
            main
            ${{ env.DEV_RELEASE }}
          registry: quay.io/redhat-certification
          username: ${{ secrets.QUAY_BOT_USERNAME }}
          password: ${{ secrets.QUAY_BOT_TOKEN }}
